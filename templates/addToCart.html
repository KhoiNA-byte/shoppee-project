<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <title>Shopee</title>
</head>
<header style="background-color: tomato; padding: 32px;">
    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
        {{if .User.Username}}
        <a class="btn btn-dark me-md-2 btn-sm" href="/addBalance">{{.UserBalances.Balance}}.000â‚«</a>
        <a class="btn btn-dark me-md-2 btn-sm position-relative" href="/addToCart">
          <i class="bi bi-cart"></i>
          {{if gt .UserCart.TotalItems 0}}
          <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill text-bg-secondary">
            {{.UserCart.TotalItems}}
            </span>
          {{end}}
        </a>
        <a class="btn btn-dark me-md-2 btn-sm text-truncate" href="/historyBuy"><i class="bi bi-person-circle"></i> {{.User.Username}}</a>
        <a class="btn btn-dark me-md-2 btn-sm" href="/logout">Logout <i class="bi bi-box-arrow-in-right"></i></a>
        {{else}}
        <a class="btn btn-dark me-md-2 btn-sm" href="/login">Login <i class="bi bi-box-arrow-in-right"></i></a>
        <a class="btn btn-dark me-md-2 btn-sm" href="/signup">Signup <i class="bi bi-box-arrow-in-right"></i></a>
        {{end}}
    </div>
    <h1 style="color: black; margin-left: 300px;">Cart <span class="badge bg-secondary">Shopee</span></h1>
</header>
<body>
    <nav class="navbar navbar-expand-lg bg-body-tertiary">
        <div class="container-fluid" style="padding: 0 50px;">
          <a class="navbar-brand " href="/">Shopee</a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0 nav-underline">
              <li class="nav-item">
                <a class="nav-link" aria-current="page" href="/">Home</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/viewListing">Market</a>
              </li>
              {{if .User.Username}}
              <li class="nav-item">
                <a class="nav-link" href="/createListing">Sale</a>
              </li>
              {{end}}
            </ul>
          </div>
        </div>
      </nav>
    <div class="container mt-4">
        <div class="container-sm p-0 bg-body-secondary">
            <div class="text-center">
                <div class="d-flex justify-content-between fw-bold fs-5 border-bottom pb-2">
                    <div class="col-4">Product</div>
                    <div class="col-2">Unit Price</div>
                    <div class="col-2">Total Price</div>
                    <div class="col-2">Quantity</div>
                    <div class="col-2">Action</div>
                </div>
            </div>
        </div>
        <form method="post" autocomplete="off" class="mt-3">
            {{range .CartItems}}
            <div class="container text-center">
                <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                    <input class="form-check-input me-2 item-checkbox" type="checkbox" data-price="{{.Price}}" data-quantity="{{.Quantity}}" data-seller="{{.Seller}}">
                    <div class="col-4 text-start"><a class="link-light link-underline link-underline-opacity-0" href="/detailListing?screenshotId={{.Screenshot}}" class="card-link"><img src="/public/pics/{{.Screenshot}}" style="width: 20%; height: 20%;">{{.Name}}</a></div>
                    <div class="col-2">{{.Price}}.000â‚«</div>
                    <div class="col-2">{{mul .Quantity .Price}}.000â‚«</div>
                    <div class="col-2">
                    <input type="number" class="form-control" name="quantity-{{.Name}}" value="{{.Quantity}}" min="1">
                    </div>
                    <div class="col-2">
                        <button type="submit" name="update" value="{{.Name}}" class="btn btn-warning btn-sm">Update</button>
                        <button type="submit" name="delete" value="{{.Name}}" class="btn btn-danger btn-sm">Delete</button>
                    </div>
                </div>
            </div>
            {{end}}
        </form>
    </div>
    <form method="post" id="checkoutForm">
    <div class="container bg-body-secondary p-2 mt-4 d-flex justify-content-between">
        <div>
            <input class="form-check-input" type="checkbox" id="selectAll">
            <label class="form-check-label fw-bold" for="selectAll">Select All</label>
        <span class="ms-3 fw-bold">Selected: <span id="selectedCount">0</span></span>
    </div>
    <div class="me-4" >
        <span class="me-3 fw-bold">Total Price: <span id="selectedTotal">0</span>.000â‚«</span>
        <input type="hidden" name="selectedItems" id="selectedItemsInput">
        <button type="submit" name="buy" value="buyNow" class="btn btn-success btn-sm">Check-Out</button>
    </div>

    </div>
    <div class="toast-container top-50 start-50 translate-middle">
      <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
          <img src="/public/pics/downloading-1154758582.png" width="20px" height="20px" class="rounded me-2" alt="...">
          <strong class="me-auto">Shoppee</strong>
          <small>just now</small>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
          Check Out successfully!
        </div>
      </div>
    </div>

    </form>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
      const success = "{{ .SuccessMessage }}";
      if (success) {
          const toastEl = document.getElementById('liveToast');
          const toast = new bootstrap.Toast(toastEl);
          toast.show();
          }
      });
    </script>
    <script>
      let itemCheckboxes;
    
      document.addEventListener("DOMContentLoaded", function () {
        const selectAllCheckbox = document.getElementById("selectAll");
        itemCheckboxes = document.querySelectorAll(".item-checkbox");
        const selectedCountEl = document.getElementById("selectedCount");
        const selectedTotalEl = document.getElementById("selectedTotal");
    
        function updateUI() {
          let count = 0;
          let total = 0;
    
          itemCheckboxes.forEach(cb => {
            if (cb.checked) {
              count++;
              const price = parseInt(cb.getAttribute("data-price")) || 0;
              const quantity = parseInt(cb.getAttribute("data-quantity")) || 0;
              total += price * quantity;
            }
          });
    
          selectedCountEl.textContent = count;
          selectedTotalEl.textContent = total;
        }
    
        // Handle select all
        selectAllCheckbox.addEventListener("change", function () {
          itemCheckboxes.forEach(cb => cb.checked = selectAllCheckbox.checked);
          updateUI();
        });
    
        // Handle individual checkbox changes
        itemCheckboxes.forEach(cb => {
          cb.addEventListener("change", function () {
            updateUI();
            // sync selectAll checkbox
            const allChecked = [...itemCheckboxes].every(c => c.checked);
            selectAllCheckbox.checked = allChecked;
          });
        });
    
        updateUI(); // initialize
      });
    
      // âœ… Move this out here so itemCheckboxes is in scope
      const checkoutForm = document.getElementById("checkoutForm");
      const selectedItemsInput = document.getElementById("selectedItemsInput");
    
      checkoutForm.addEventListener("submit", function (e) {
        const selected = [];
    
        itemCheckboxes.forEach(cb => {
        if (cb.checked) {
          const parentRow = cb.closest(".d-flex");
          const name = parentRow.querySelector("a").textContent.trim();
          const price = parseInt(cb.getAttribute("data-price"));
          const quantity = parseInt(cb.getAttribute("data-quantity"));
          const seller = cb.getAttribute("data-seller"); // ðŸ’¥ new

          selected.push({ name, price, quantity, seller });
        }
      });    
        selectedItemsInput.value = JSON.stringify(selected);
    
        if (selected.length === 0) {
          e.preventDefault();
          alert("Please select at least one item to check out.");
        }
      });
    </script>
    
</body>
</html>
